#! /usr/bin/env bash

declare cmd_name options vname dot_exec resolved_path

IFS=':'
read cmd_name options vname <<< "$(echo $* | sed -r 's/^([^[:space:]]+)[[:space:]]?(.*)[[:space:]]([^[:space:]]+)$/\1:\2:\3/')"
IFS=


if [[ -z $cmd_name ]]
then
	echo "Missing following arguments: Sub-Command"
	exit 1
fi


if [[ -z $vname ]] && [[ "$cmd_name" != "--" ]]
then
	echo "Missing following arguments: Virtual Machine Name"
	exit 1
fi


# resolve [--] short hand
if [[ "$cmd_name" == "--" ]]
then
	cmd_name="raw"
	options="-q -- ${options} ${vname}"
else
	# export vname
	declare -x vname
fi

# convert options into array
declare -a options="(${options})"


# form subcommand exec pathname
resolved_path="${sub_cmd_pathname}/${cmd_name}"
dot_exec="${resolved_path}/.exec"

# throw error if no exec file is found
if [[ ! -f $dot_exec ]]
then
	echo "Sub-command exec file not found at: \"${dot_exec}\""
fi

# parse options if provided
if [[ -n $options ]]
then
	options_parser ${options[@]}
fi

# export sub_command_path
declare -x cwd=$resolved_path

# execute subcommand
bash $dot_exec

